(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3bbe1a7e"],{"0563":function(s,t,a){s.exports=a.p+"img/rp_filter1.028cd143.png"},"4bf5":function(s,t,a){s.exports=a.p+"img/server_static_route.78b834ae.png"},6035:function(s,t,a){s.exports=a.p+"img/ips.9b472aef.png"},"6a53":function(s,t,a){s.exports=a.p+"img/icmp_no_return.f6e18a34.png"},"776e":function(s,t,a){s.exports=a.p+"img/business.e110763d.png"},9310:function(s,t,a){s.exports=a.p+"img/rp_filter_return.d1d39acb.png"},"9d2e":function(s,t,a){function e(){var s=function(){var s=this,t=s.$createElement;s._self._c;return s._m(0)},t=[function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("div",{staticClass:"frontmatter-markdown"},[e("h1",[s._v("ALL IN ONE SERVE")]),s._v(" "),e("p",[s._v("本文主要探索在复杂的网络拓扑测试上，对于多服务器有较高的需求的。怎么通过一个服务器来满足实现多服务器的效果。如下图。基本参数为:")]),s._v(" "),e("ol",[e("li",[s._v("eth1: 105.100.1.0/24")]),s._v(" "),e("li",[s._v("eth2：106.100.1.0/24")]),s._v(" "),e("li",[s._v("eth3：110.100.1.0/24")]),s._v(" "),e("li",[s._v("eth4：105.110.1.0/24")])]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("776e")}}),s._v(" "),e("p",[s._v("在实现过程中，有几个问题，这里一一记录下。")]),s._v(" "),e("ol",[e("li",[s._v("如果多网卡配置默认路由或者只配置默认路由，出现非对称路由回包，是服务器端不回包。")]),s._v(" "),e("li",[s._v("非对称路由回的包被网关吞包丢弃了（怀疑）")])]),s._v(" "),e("h4",[s._v("非对称路由回包问题：")]),s._v(" "),e("p",[s._v("首先看我的centos7的路由表，只配置了一个默认路由，从eth1回包。就是说我在103.100.1.201 发出一个icmp-request包到eth2（110.100.1.2），正常来说服务器查路由表，将icmp-reply包从eth1出去，回到下一跳。")]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("4bf5")}}),s._v(" "),e("p",[s._v("而我的内核驱动关闭了非对称路由回包。什么意思呢？在ping的时候，你在服务器抓any网口的icmp包，只会看到有request包，而不会有reply包。")]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("6a53")}}),s._v(" "),e("p",[s._v("很奇怪，明明已经是目的了，怎么没有生成reply包。当然，你理解这个的时候，认为是其实是有生成reply包的，只是不往网卡上发或者往网卡上发的时候被拦截了，所以在网卡上没有抓到。我觉得两种理解都行，现象是一样的，有兴趣的继续深扒。那么怎么看是不是限制了非对称路由回包呢。 filter=1则为限制非对称路由回包。（听说正常应该是关闭限制的）")]),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v(" sysctl -a | grep '\\.rp_filter'\n")])]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("0563")}}),s._v(" "),e("p",[s._v("那么，关闭限制后，看看会是怎么样的呢？我们发现，eth3口的是只有request包，而reply的包是在eth1口 ？")]),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v("# 修改配置为"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(" 注意时临时配置，重启网络时会重新改回去。\n"),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v('" > /proc/sys/'),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("net")]),s._v("/ipv4/conf/all/rp_filter && "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v('" > /proc/sys/'),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("net")]),s._v("/ipv4/conf/default/rp_filter && "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v('" > /proc/sys/'),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("net")]),s._v("/ipv4/conf/eth0/rp_filter\n")])]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("9310")}}),s._v(" "),e("p",[s._v("即使它是非对称回包，但是正常情况是没有影响的，103.100.1.201 应该是可以收到回包了。此时链路就是正常的了。那么，我挂载多张网卡，每张网卡上挂载多个ip，多网卡就意味着存在多个MAC地址了，就能模拟多服务器了。（多IP为了有一些特殊需求），这里列出我的多网卡信息：")]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("6035")}}),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v("# 这里赘述一下centos配置ip和路由的情况\ncp -p /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth1\nvi /etc/sysconfig/network-scripts/ifcfg-eth1 # 根据自己需要进行修改配置 (GATEWAY字段按需配置，我这里只配一个网口有默认网关)\ntouch /etc/sysconfig/network-scripts/route-eth1\n"),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("103")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" via "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("105")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(' dev eth1" > /etc/sysconfig/network-scripts/route-eth1  \n# 配永久静态路由（统一由eth1回包给PC，'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("105")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("是网关）\nservice network restart \n# 重启后记得重新关闭非对称路由回包\n"),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v('" > /proc/sys/'),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("net")]),s._v("/ipv4/conf/all/rp_filter && "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v('" > /proc/sys/'),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("net")]),s._v("/ipv4/conf/default/rp_filter && "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v('" > /proc/sys/'),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("net")]),s._v("/ipv4/conf/eth0/rp_filter\n")])]),s._v(" "),e("p",[s._v("打完收工。")]),s._v(" "),e("h4",[s._v("链路吞包问题：")]),s._v(" "),e("p",[s._v("出事了，出事了~ 有一天突然ping不通服务器了。我看到服务器还是有正常回包。但是路由这里没有抓到包了。唉，很难。不知道是不是非对称回包的被路由器（或者防火墙拦截）丢弃了。呃，翻车翻车。")]),s._v(" "),e("p",[s._v("那就只能是从哪张网口进，哪张网口出了。 这里就要引入策略路由了。一般情况下，策略路由优先于静态路由，静态路由优先于默认路由，那么，在命中静态路由（103.100.1.0/24 via 105.100.1.1 dev eth1）之前，将到eth1网口流量的包，回包由eth1下一跳到网关，这样可以实现需求。同理，将其他的各个网卡都配一遍策略路由，那就可以实现从哪张网口进，哪张网口。")]),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("202")]),s._v(' table3" >>  /etc/iproute2/rt_tables    # 追加一张路由表（table3），权重'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("200")]),s._v("到策略路由\nip route flush table table3    # 刷新table3\nip route add default via "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" table table3   # 给table3写入路由，默认下一跳是"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("（eth3的网关）\nip rule add to "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" table table3 pref "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v(" # 增加路由规则，目的网段为"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v("（eth3业务）的，查找命中table3\n# 简单解释下：设备拿到一个目的ip为"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v("的icmp包后，查看table3的路由进行转发。而table3，让它的下一跳是eth3出去，到eth3的网关。\n")])]),s._v(" "),e("p",[s._v("翻车了。这样配是不行的。哈哈，很伤。为什么呢，你细细阅读下上边命令中的简单解释。")]),s._v(" "),e("p",[s._v("没错，进行"),e("strong",[s._v("转发")]),s._v("。")]),s._v(" "),e("p",[s._v("request包已经到目的了，to 110.100.1.0/24 这个转发动作不再发生了。所以这个策略路由是不命中的。")]),s._v(" "),e("p",[s._v("那么思考下，下一个转发动作要怎么发生？")]),s._v(" "),e("p",[s._v("回包时发生转发动作：from 110.100.1.0/24 watch table3（icmp-reply的源为110.100.1.2，开始回包。命中table3）")]),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v("# 删除已有规则\nip rule "),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("del")]),s._v(" table table3\nip rule add  from "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" table table3 pref "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("\n")])]),s._v(" "),e("p",[s._v("配置完后的路由规则")]),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v("ip rule  # 查看路由规则\n\n")])]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("cceb")}}),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v("ip route show table table3\n# default via "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" dev eth3 \n")])]),s._v(" "),e("p",[s._v("可以了。这下可以在eth3上抓到request包和reply包了（这里我换了一台同网段PCping的，不过没关系，同理）")]),s._v(" "),e("img",{staticStyle:{zoom:"80%"},attrs:{src:a("b0f9")}}),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v("# 那其他网口的一并加上吧\n"),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("203")]),s._v(' table1" >>  /etc/iproute2/rt_tables  \nip route flush table table1 \nip route add default via '),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("105")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" table table1  \nip rule add from "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("105")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" table table1 pref "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("echo")]),s._v(' "'),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("204")]),s._v(' table2" >>  /etc/iproute2/rt_tables  \nip route flush table table2\nip route add default via '),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("106")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" table table2  \nip rule add from "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("106")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" table table2 pref "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("\n")])]),s._v(" "),e("p",[s._v("最后，这样配的策略路由是临时的。需要将它永久配置，这里提供一个简单的方法：加到开机运行脚本中：/etc/rc.local")]),s._v(" "),e("pre",[e("code",{pre:!0,attrs:{class:"hljs language-cmd"}},[s._v("# 如下命令追加到/etc/rc.local中\n\nip route flush table table1\nip route add default via "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("105")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" table table1\nip rule add from "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("105")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" table table1 pref "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("\n\nip route flush table table2                                                                                                        \nip route add default via "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("106")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" table table2                                                                                 \nip rule add from "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("106")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" table table2 pref "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("\n\nip route flush table table3                                                                                                        \nip route add default via "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" table table3                                                                              \nip rule add from "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("110")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v("."),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("/"),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(" table table3 pref "),e("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("100")]),s._v("\n")])]),s._v(" "),e("p",[s._v("打完收工。")])])}];return{render:s,staticRenderFns:t}}const r=e();s.exports={attributes:{},vue:{component:{data:function(){return{templateRender:null}},render:function(s){return this.templateRender?this.templateRender():s("div","Rendering")},created:function(){this.templateRender=r.render,this.$options.staticRenderFns=r.staticRenderFns}}}}},b0f9:function(s,t,a){s.exports=a.p+"img/ping_ok.5a0dabdc.png"},cceb:function(s,t,a){s.exports=a.p+"img/ip_rule.2b69a115.png"}}]);
//# sourceMappingURL=chunk-3bbe1a7e.06fb7ee3.js.map